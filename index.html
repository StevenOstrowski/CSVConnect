<!DOCTYPE html>
<html>
<head>
    <title>CSV Loader Pro</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #fff; }
        .btn { background: #0078d4; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; border-radius: 2px; }
        #status { margin-top: 15px; font-size: 12px; color: #d83b01; font-family: monospace; white-space: pre-wrap; }
        .success { color: #107c10 !important; }
    </style>
</head>
<body>
    <h3>CSV Point Loader</h3>
    <button class="btn" onclick="pickFile()">Select CSV from Project</button>
    <div id="status">Connecting to viewer...</div>

    <script>
        let connectAPI;

        async function init() {
            try {
                connectAPI = await TrimbleConnectWorkspace.connect(window.parent);
                setStatus("Connected! Ready.", true);
            } catch (e) {
                setStatus("Connection failed: " + e.message);
            }
        }

        function setStatus(msg, isSuccess = false) {
            const el = document.getElementById('status');
            el.innerText = msg;
            el.className = isSuccess ? 'success' : '';
        }

      async function pickFile() {
            try {
                const files = await connectAPI.ui.showFilePicker();
                if (!files || files.length === 0) return;
                
                const file = files[0];
                setStatus("Downloading: " + file.name + "...");

                // NEW METHOD: Use the API to get the file stream/blob directly
                // This avoids CORS issues because the Parent (Trimble) does the work
                const fileBlob = await connectAPI.data.getFileContent(file.id);
                
                // Convert the blob to text
                const csvData = await fileBlob.text();
                
                setStatus("Parsing data...");
                processCSV(csvData);

            } catch (err) {
                console.error(err);
                setStatus("Error: " + err.message);
                // If it fails, let's see if it's a permission issue
                if(err.message.includes("permission")) {
                    setStatus("Error: Extension needs 'data.read' permission in manifest.");
                }
            }
        }

        async function processCSV(data) {
            const rows = data.split(/\r?\n/);
            const markers = [];

            rows.forEach((row, i) => {
                const cols = row.split(',');
                if (cols.length >= 4) {
                    const [name, x, y, z] = cols.map(c => c.trim());
                    const px = parseFloat(x);
                    const py = parseFloat(y);
                    const pz = parseFloat(z);

                    if (!isNaN(px) && !isNaN(py) && !isNaN(pz)) {
                        markers.push({
                            id: "pt_" + i + "_" + Date.now(),
                            title: name || "Point " + i,
                            position: { x: px, y: py, z: pz },
                            color: "#FF0000"
                        });
                    }
                }
            });

            if (markers.length > 0) {
                await connectAPI.viewer.addIcon(markers);
                setStatus("Successfully loaded " + markers.length + " points!", true);
            } else {
                setStatus("Error: No valid X,Y,Z data found in the CSV.");
            }
        }

        init();
    </script>
</body>
</html>

