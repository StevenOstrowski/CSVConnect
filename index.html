<!DOCTYPE html>
<html>
<head>
    <title>CSV Loader - Enhanced</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 15px; background: #fff; color: #333; }
        #drop-zone {
            border: 2px dashed #0078d4;
            border-radius: 8px;
            padding: 30px 10px;
            text-align: center;
            background: #f0f7ff;
            cursor: pointer;
            transition: 0.3s;
        }
        #drop-zone.hover { background: #d0e7ff; }
        .btn-clear { 
            background: #d83b01; color: white; border: none; padding: 8px; 
            width: 100%; cursor: pointer; border-radius: 2px; margin-top: 10px; font-weight: bold;
        }
        #status { margin-top: 15px; font-size: 13px; min-height: 20px; }
        .success { color: #107c10; }
        .sample-link { display: block; margin-top: 20px; font-size: 11px; color: #0078d4; text-decoration: none; }
        .sample-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h3>CSV Point Loader</h3>
    
    <div id="drop-zone" id="dropZone">
        <p><b>Drag & Drop CSV</b><br>or click to browse</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
    </div>

    <button class="btn-clear" onclick="clearPoints()">Clear All Points</button>

    <div id="status">Connecting...</div>

    <a href="#" class="sample-link" onclick="downloadSample()">ðŸ“¥ Download Sample CSV Template</a>

    <script>
        let connectAPI;
        const status = document.getElementById('status');
        let loadedPointIds = [];

        async function init() {
            try {
                connectAPI = await TrimbleConnectWorkspace.connect(window.parent);
                status.innerText = "Connected and ready.";
            } catch (e) {
                status.innerText = "Connection failed.";
            }
        }

        // Drag & Drop Logic
        const dz = document.getElementById('drop-zone');
        const fi = document.getElementById('fileInput');
        dz.onclick = () => fi.click();
        dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('hover'); };
        dz.ondragleave = () => dz.classList.remove('hover');
        dz.ondrop = (e) => {
            e.preventDefault();
            dz.classList.remove('hover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };
        fi.onchange = (e) => { if (e.target.files.length) handleFile(e.target.files[0]); };

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => processCSV(event.target.result);
            reader.readAsText(file);
        }

        async function processCSV(data) {
            const rows = data.split(/\r?\n/);
            const markers = [];
            
            rows.forEach((row, i) => {
                const cols = row.split(',');
                if (cols.length >= 4) {
                    const [name, x, y, z] = cols.map(c => c.trim());
                    const px = parseFloat(x), py = parseFloat(y), pz = parseFloat(z);
                    if (!isNaN(px)) {
                        const id = "pt_" + Date.now() + "_" + i;
                        markers.push({ id, title: name || `Pt ${i}`, position: { x: px, y: py, z: pz }, color: "#FF0000" });
                        loadedPointIds.push(id);
                    }
                }
            });

            if (markers.length > 0) {
                await connectAPI.viewer.addIcon(markers);
                status.innerHTML = `<span class="success">Loaded ${markers.length} points!</span>`;
            }
        }

        async function clearPoints() {
            if (loadedPointIds.length > 0) {
                await connectAPI.viewer.removeIcon(loadedPointIds);
                loadedPointIds = [];
                status.innerText = "All points cleared.";
            }
        }

        function downloadSample() {
            const content = "Name,X,Y,Z\nPoint1,10,10,2\nPoint2,20,15,5";
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'template.csv');
            a.click();
        }

        init();
    </script>
</body>
</html>
