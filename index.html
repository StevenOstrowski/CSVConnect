<!DOCTYPE html>
<html>
<head>
    <title>CSV Loader - Drag & Drop</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 15px; background: #fff; color: #333; }
        #drop-zone {
            border: 2px dashed #0078d4;
            border-radius: 8px;
            padding: 40px 10px;
            text-align: center;
            background: #f0f7ff;
            cursor: pointer;
            transition: background 0.3s;
        }
        #drop-zone.hover { background: #d0e7ff; border-style: solid; }
        #status { margin-top: 20px; font-size: 13px; line-height: 1.4; color: #444; }
        .success { color: #107c10; font-weight: bold; }
        .error { color: #d83b01; }
        .instructions { font-size: 11px; color: #888; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>
    <h3>CSV Point Loader</h3>
    
    <div id="drop-zone">
        <p><b>Drag & Drop CSV</b><br>or click to browse</p>
        <input type="file" id="fileInput" accept=".csv" style="display:none">
    </div>

    <div id="status">Connecting to 3D Viewer...</div>

    <div class="instructions">
        <b>Required Format:</b><br>
        Name, X, Y, Z<br>
        <i>Note: Coordinates should match model units (usually meters).</i>
    </div>

    <script>
        let connectAPI;
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');

        // 1. Initialize Connection
        async function init() {
            try {
                connectAPI = await TrimbleConnectWorkspace.connect(window.parent);
                status.innerText = "Connected! Ready for your CSV file.";
            } catch (e) {
                status.innerHTML = '<span class="error">Connection failed. Are you in the 3D Viewer?</span>';
            }
        }

        // 2. Setup Drag & Drop Listeners
        dropZone.onclick = () => fileInput.click();

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('hover');
        };

        dropZone.ondragleave = () => dropZone.classList.remove('hover');

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('hover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };

        fileInput.onchange = (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        };

        // 3. Process the File
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                status.innerHTML = '<span class="error">Please upload a .csv file.</span>';
                return;
            }

            status.innerText = `Reading ${file.name}...`;
            const reader = new FileReader();
            
            reader.onload = (event) => {
                const text = event.target.result;
                processCSV(text);
            };
            
            reader.onerror = () => {
                status.innerHTML = '<span class="error">Failed to read file.</span>';
            };

            reader.readAsText(file);
        }

        async function processCSV(data) {
            const rows = data.split(/\r?\n/);
            const markers = [];

            rows.forEach((row, i) => {
                const cols = row.split(',');
                if (cols.length >= 4) {
                    const [name, x, y, z] = cols.map(c => c.trim());
                    const px = parseFloat(x);
                    const py = parseFloat(y);
                    const pz = parseFloat(z);

                    if (!isNaN(px) && !isNaN(py) && !isNaN(pz)) {
                        markers.push({
                            id: "pt_" + i + "_" + Date.now(),
                            title: name || `Point ${i}`,
                            position: { x: px, y: py, z: pz },
                            color: "#FF0000" // Red markers
                        });
                    }
                }
            });

            if (markers.length > 0) {
                try {
                    await connectAPI.viewer.addIcon(markers);
                    status.innerHTML = `<span class="success">Successfully loaded ${markers.length} points!</span>`;
                } catch (err) {
                    status.innerHTML = `<span class="error">Viewer Error: ${err.message}</span>`;
                }
            } else {
                status.innerHTML = '<span class="error">No valid X,Y,Z data found. Check your CSV format.</span>';
            }
        }

        init();
    </script>
</body>
</html>
