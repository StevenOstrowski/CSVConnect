<!DOCTYPE html>
<html>
<head>
    <title>3D Sphere Loader - Diagnostic</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #fff; }
        .box { border: 2px dashed #0078d4; padding: 20px; text-align: center; background: #f0f7ff; cursor: pointer; }
        .btn { color: white; border: none; padding: 10px; width: 100%; cursor: pointer; border-radius: 2px; margin-top: 8px; font-weight: bold; }
        #status { margin-top: 15px; font-size: 12px; padding: 8px; border-radius: 4px; }
        .err { background: #fde7e9; color: #d83b01; border: 1px solid #d83b01; }
        .ok { background: #dff6dd; color: #107c10; border: 1px solid #107c10; }
    </style>
</head>
<body>
    <h3>3D Sphere Diagnostic</h3>
    
    <div class="box" onclick="document.getElementById('fi').click()">
        <b>Drop CSV Here</b>
        <input type="file" id="fi" accept=".csv" style="display:none" onchange="handleFile(this.files[0])">
    </div>

    <div id="status">Initializing...</div>

    <button class="btn" style="background:#0078d4" onclick="testSphere()">Create Test Sphere at 0,0,0</button>
    <button class="btn" style="background:#107c10" onclick="zoomToPoints()">üî≠ Zoom to Points</button>
    <button class="btn" style="background:#d83b01" onclick="clearPoints()">üóëÔ∏è Clear All</button>

    <script>
        let connectAPI;
        let loadedIds = [];
        let positions = [];

        async function init() {
            try {
                connectAPI = await TrimbleConnectWorkspace.connect(window.parent);
                const canDoObjects = !!(connectAPI.viewer && connectAPI.viewer.objects);
                if (canDoObjects) {
                    setStat("‚úÖ Viewer Ready. Drag file or click Test.", "ok");
                } else {
                    setStat("‚ùå ERROR: Objects Module missing. Delete and re-add extension in Settings!", "err");
                }
            } catch (e) { setStat("Connection Failed.", "err"); }
        }

        function setStat(txt, cls) {
            const s = document.getElementById('status');
            s.innerText = txt;
            s.className = cls;
        }

        async function testSphere() {
            const id = "test_" + Date.now();
            const sphere = [{
                id: id, type: "sphere", radius: 2.0, // Big sphere
                position: {x:0, y:0, z:0},
                color: { r: 0, g: 255, b: 0, a: 255 } // Green
            }];
            await connectAPI.viewer.objects.add(sphere);
            loadedIds.push(id);
            positions.push({x:0, y:0, z:0});
            setStat("Green Sphere added at 0,0,0", "ok");
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file);
        }

        async function processCSV(data) {
            const rows = data.split(/\n/);
            const spheres = [];
            rows.forEach((row, i) => {
                const c = row.split(',').map(v => v.trim());
                if (c.length >= 4 && !isNaN(parseFloat(c[1]))) {
                    const pos = { x: parseFloat(c[1]), y: parseFloat(c[2]), z: parseFloat(c[3]) };
                    const id = "s_" + Date.now() + "_" + i;
                    spheres.push({ id, type: "sphere", radius: 1.5, position: pos, color: {r:255,g:0,b:0,a:255} });
                    loadedIds.push(id);
                    positions.push(pos);
                }
            });
            await connectAPI.viewer.objects.add(spheres);
            setStat(`Loaded ${spheres.length} spheres.`, "ok");
        }

        async function zoomToPoints() {
            if (!positions.length) return;
            const avg = positions.reduce((a, b) => ({x: a.x + b.x, y: a.y + b.y, z: a.z + b.z}), {x:0,y:0,z:0});
            const center = { x: avg.x/positions.length, y: avg.y/positions.length, z: avg.z/positions.length };
            await connectAPI.viewer.camera.setTarget(center);
        }

        async function clearPoints() {
            await connectAPI.viewer.objects.remove(loadedIds);
            loadedIds = []; positions = [];
            setStat("Cleared.", "ok");
        }

        window.onload = init;
    </script>
</body>
</html>
