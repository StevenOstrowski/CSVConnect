<!DOCTYPE html>
<html>
<head>
    <title>CSV Sphere Loader</title>
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: white; color: #333; }
        #drop-zone { 
            border: 3px dashed #0078d4; padding: 30px; text-align: center; 
            background: #f0f7ff; cursor: pointer; margin-bottom: 20px;
        }
        .btn { 
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        }
        #status { 
            padding: 10px; border-radius: 4px; margin-bottom: 10px; 
            background: #eee; font-size: 14px; font-weight: bold;
        }
        .error-msg { color: #d83b01; background: #fde7e9; }
        .success-msg { color: #107c10; background: #dff6dd; }
    </style>
</head>
<body>

    <h3>CSV 3D Sphere Loader</h3>

    <div id="status">Waiting for Trimble Connect...</div>

    <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
        <strong>DRAG CSV HERE</strong><br>or click to browse
        <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleFile(this.files[0])">
    </div>

    <button class="btn" style="background: #0078d4;" onclick="testSphere()">1. Test: Create Green Sphere</button>
    <button class="btn" style="background: #107c10;" onclick="zoomToPoints()">2. Zoom to Spheres</button>
    <button class="btn" style="background: #d83b01;" onclick="clearPoints()">3. Clear All</button>

    <script>
        let connectAPI;
        let loadedIds = [];
        let positions = [];

        // 1. Initialize immediately
        async function start() {
            const statusBox = document.getElementById('status');
            try {
                // Ensure the API exists before calling it
                if (typeof TrimbleConnectWorkspace === 'undefined') {
                    statusBox.innerText = "Error: Trimble API Script not found.";
                    statusBox.className = "error-msg";
                    return;
                }

                connectAPI = await TrimbleConnectWorkspace.connect(window.parent);
                statusBox.innerText = "âœ… Connected to Viewer";
                statusBox.className = "success-msg";
            } catch (e) {
                statusBox.innerText = "Connection Failed: " + e.message;
                statusBox.className = "error-msg";
            }
        }

        // 2. Create a test sphere
        async function testSphere() {
            try {
                if (!connectAPI.viewer || !connectAPI.viewer.objects) {
                    alert("Permission Denied: viewer.objects not found in manifest.");
                    return;
                }

                const id = "test_" + Date.now();
                const sphere = [{
                    id: id,
                    type: "sphere",
                    radius: 2.0,
                    position: { x: 0, y: 0, z: 0 },
                    color: { r: 0, g: 255, b: 0, a: 255 }
                }];

                await connectAPI.viewer.objects.add(sphere);
                loadedIds.push(id);
                positions.push({ x: 0, y: 0, z: 0 });
                document.getElementById('status').innerText = "Green Sphere added at 0,0,0";
            } catch (err) {
                alert("Viewer Error: " + err.message);
            }
        }

        // 3. Handle the File
        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file);
        }

        async function processCSV(data) {
            const rows = data.split(/\r?\n/);
            const spheres = [];
            
            rows.forEach((row, i) => {
                const cols = row.split(',').map(v => v.trim());
                if (cols.length >= 4 && !isNaN(parseFloat(cols[1]))) {
                    const pos = { 
                        x: parseFloat(cols[1]), 
                        y: parseFloat(cols[2]), 
                        z: parseFloat(cols[3]) 
                    };
                    const id = "s_" + Date.now() + "_" + i;
                    spheres.push({ 
                        id: id, 
                        type: "sphere", 
                        radius: 1.0, 
                        position: pos, 
                        color: { r: 255, g: 0, b: 0, a: 255 } 
                    });
                    loadedIds.push(id);
                    positions.push(pos);
                }
            });

            if (spheres.length > 0) {
                await connectAPI.viewer.objects.add(spheres);
                document.getElementById('status').innerText = "Loaded " + spheres.length + " spheres.";
            }
        }

        async function zoomToPoints() {
            if (positions.length > 0) {
                const avg = positions.reduce((a, b) => ({ x: a.x + b.x, y: a.y + b.y, z: a.z + b.z }), { x: 0, y: 0, z: 0 });
                const center = { x: avg.x / positions.length, y: avg.y / positions.length, z: avg.z / positions.length };
                await connectAPI.viewer.camera.setTarget(center);
            }
        }

        async function clearPoints() {
            if (loadedIds.length > 0) {
                await connectAPI.viewer.objects.remove(loadedIds);
                loadedIds = [];
                positions = [];
                document.getElementById('status').innerText = "Cleared.";
            }
        }

        // Run start when window loads
        window.onload = start;
    </script>
</body>
</html>
