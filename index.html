<script>
    let api;
    
    async function init() {
        const statusBox = document.getElementById('status');
        try {
            // This 'allowedOrigins' line is critical for the Quadri error you saw
            api = await TrimbleConnectWorkspace.connect(
                window.parent,
                (event) => {
                    // This tells your app to trust messages from Trimble domains
                    return event.origin.includes('trimble.com');
                },
                30000
            );
            statusBox.innerText = "✅ Connected!";
            statusBox.style.color = "green";
        } catch (e) {
            statusBox.innerText = "❌ Connection Failed";
            console.error("Connect error:", e);
        }
    }

    async function testSphere() {
        if (!api || !api.viewer || !api.viewer.objects) {
            alert("API not ready or permissions missing!");
            return;
        }
        const sphere = [{
            id: "test_" + Date.now(),
            type: "sphere",
            radius: 2.0,
            position: { x: 0, y: 0, z: 0 },
            color: { r: 0, g: 255, b: 0, a: 255 }
        }];
        await api.viewer.objects.add(sphere);
    }

    window.onload = init;
</script>
