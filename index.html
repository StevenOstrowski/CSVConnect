<script>
    let api;
    async function init() {
        const status = document.getElementById('status');
        try {
            // We use a broader origin check to satisfy Quadri's security
            api = await TrimbleConnectWorkspace.connect(
                window.parent, 
                (event) => true, // Accept all messages for now to bypass security blocks
                30000
            );
            
            // Explicitly try to set the menu in case Trimble is waiting
            if (api.ui && api.ui.setMenu) {
                await api.ui.setMenu({
                    title: "Sphere Loader",
                    command: "open_loader"
                });
            }
            
            status.innerText = "✅ Bridge Established";
            status.style.color = "green";
        } catch (e) {
            status.innerText = "❌ Handshake Blocked";
            console.error(e);
        }
    }
    window.onload = init;
</script>
